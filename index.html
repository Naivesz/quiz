<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeopardy Quiz Show Deluxe - Camera Enabled</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Kanit:wght@600;800;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --blue-dark: #020617;
            --blue-main: #0a192f;
            --blue-card: #1e3a8a;
            --blue-highlight: #3b82f6;
            --red-accent: #e11d48;
            --green-success: #22c55e;
            --text-gold: #fde047;
            --font-show: 'Anton', sans-serif;
            --font-text: 'Kanit', sans-serif;
        }

        html, body {
            background-color: transparent !important;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            color: white;
            font-family: var(--font-text);
            display: flex; flex-direction: column;
        }

        body.is-player .host-only { display: none !important; }
        body.is-player .quiz-card { cursor: default !important; }

        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 2000;
            opacity: 0; transition: opacity 0.1s ease-out;
        }

        .top-bar {
            display: grid; grid-template-columns: 20% 1fr 20%; 
            align-items: center; padding: 10px 30px;
            background: var(--blue-dark); border-bottom: 3px solid var(--blue-highlight);
            flex-shrink: 0; z-index: 1100;
        }

        .gm-cam-slot {
            width: 100%; aspect-ratio: 16/9;
            background: transparent !important;
            border: 3px solid var(--red-accent); border-radius: 10px; position: relative;
            overflow: hidden; /* Wichtig für Video-Einpassung */
        }

        .gm-label {
            position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            background: var(--red-accent); padding: 2px 15px; font-size: 0.8rem;
            font-family: var(--font-show); border-radius: 4px; z-index: 2; /* Über dem Video */
        }

        .nav-controls { text-align: center; }
        .logo-text { font-family: var(--font-show); font-size: 2.2rem; color: var(--text-gold); margin: 0; }

        .btn-nav {
            background: var(--blue-card); border: 1px solid var(--blue-highlight);
            color: white; padding: 5px 15px; font-family: var(--font-show);
            cursor: pointer; margin: 5px 2px; border-radius: 4px;
        }

        .btn-nav.active { background: var(--blue-highlight); box-shadow: 0 0 10px var(--blue-highlight); }
        .btn-reset { background: var(--red-accent); border: none; color: white; padding: 8px 15px; font-family: var(--font-show); cursor: pointer; border-radius: 4px; }

        .turn-container {
            text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 5px;
        }

        #current-turn-display {
            font-family: var(--font-show); color: var(--text-gold); font-size: 1.6rem;
            text-transform: uppercase; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #board-container { position: relative; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }

        #game-board {
            display: grid; 
            grid-template-columns: repeat(6, 1fr);
            grid-auto-rows: auto;
            gap: 10px; padding: 15px 30px; background: var(--blue-dark); height: 100%;
        }

        .category-header {
            background: linear-gradient(to bottom, var(--red-accent), #991b1b);
            padding: 10px 5px; text-align: center; font-family: var(--font-show);
            font-size: 1.1rem; text-transform: uppercase; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 50px;
        }

        .quiz-card {
            background: linear-gradient(145deg, var(--blue-card), var(--blue-main));
            border: 2px solid var(--blue-highlight); border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2rem; font-family: var(--font-show); color: var(--text-gold); cursor: pointer;
            min-height: 80px;
        }

        .quiz-card.used { opacity: 0.05; cursor: default; }

        .player-area {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 15px; padding: 15px 30px;
            background: var(--blue-dark); border-top: 5px solid var(--blue-highlight);
            flex-shrink: 0; z-index: 1100;
        }

        .player-slot {
            aspect-ratio: 16/9; background: transparent !important;
            border: 2px solid #333; position: relative; border-radius: 8px;
            overflow: hidden; /* Wichtig für Video */
        }

        .player-slot.active-buzzer { border-color: var(--red-accent); box-shadow: 0 0 20px var(--red-accent); }
        .player-slot.selecting { border-color: var(--text-gold); border-style: dashed; }

        .player-info {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(225, 29, 72, 0.95); text-align: center;
            font-weight: 900; font-size: 1rem; padding: 5px 0; text-transform: uppercase;
            z-index: 2; /* Über dem Video */
        }

        #question-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 1050; flex-direction: column; align-items: center; justify-content: center;
        }

        #question-content {
            font-size: clamp(1.5rem, 4vw, 3.2rem); 
            font-weight: 800; 
            max-width: 85%; 
            max-height: 60vh;
            margin: 20px 0;
            text-align: center; 
            text-shadow: 2px 2px 15px rgba(0,0,0,0.9);
            overflow-y: auto; 
            scrollbar-width: none;
            -ms-overflow-style: none;
            line-height: 1.2;
        }
        #question-content::-webkit-scrollbar { display: none; }

        .controls { display: flex; gap: 15px; }
        button { padding: 12px 25px; font-family: var(--font-show); cursor: pointer; border: none; border-radius: 6px; color: white; }
        .btn-correct { background: var(--green-success); }
        .btn-wrong { background: var(--red-accent); }
        .btn-close { background: #475569; }
    </style>
</head>
<body onclick="unlockAudio()">

<audio id="sound-correct" src="correct.mp3" preload="auto"></audio>
<audio id="sound-wrong" src="wrong.mp3" preload="auto"></audio>
<audio id="sound-buzzer" src="buzzer.mp3" preload="auto"></audio>

<div id="flash-overlay"></div>

<div class="top-bar">
    <div class="gm-cam-slot"><div class="gm-label">NAIVES</div></div>
    <div class="nav-controls">
        <h1 class="logo-text">QUIZ DUELL</h1>
        <div class="host-only">
            <button id="btn-b1" class="btn-nav active" onclick="switchBoard(1)">BOARD 1</button>
            <button id="btn-b2" class="btn-nav" onclick="switchBoard(2)">BOARD 2</button>
        </div>
    </div>
    <div class="turn-container">
        <button class="btn-reset host-only" onclick="resetGame()">RESET</button>
        <div id="current-turn-display">AM ZUG: -</div>
    </div>
</div>

<div id="board-container">
    <div id="game-board"></div>
    <div id="question-overlay">
        <div id="buzzer-status" style="font-family: var(--font-show); font-size: 2rem; color: var(--text-gold); margin-bottom: 10px;"></div>
        <div id="question-content"></div>
        <div class="controls host-only" id="action-controls">
            <button class="btn-correct" onclick="handleAnswer(true)">RICHTIG</button>
            <button class="btn-wrong" onclick="handleAnswer(false)">FALSCH</button>
            <button class="btn-close" onclick="closeQuestion()">ZURÜCK</button>
        </div>
    </div>
</div>

<div class="player-area" id="player-area"></div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBP2hzronbnt530dAEr906xMS8xzmg3bpo",
      authDomain: "quizshownaives.firebaseapp.com",
      databaseURL: "https://quizshownaives-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "quizshownaives",
      storageBucket: "quizshownaives.firebasestorage.app",
      messagingSenderId: "569001129434",
      appId: "1:569001129434:web:87f6e6af8ac09296163ce3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('game_state');

    const urlParams = new URLSearchParams(window.location.search);
    const myPlayerIndex = urlParams.has('p') ? parseInt(urlParams.get('p')) - 1 : null;
    const isHost = (myPlayerIndex === null);

    // NEU: Globale Variablen für Video-Management und PeerJS
    let myVideoElement = null;
    let localStream = null;
    let myPeer = null;
    let peers = {}; // Speichert aktive Verbindungen
    let videoElements = {}; // Speichert Video-DOM-Elemente pro Index (0-4)

    // ERWEITERT: Kamera & PeerJS Initialisierung
    async function initCamera() {
        try {
            // 1. Lokaler Stream
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            localStream = stream;
            
            // Lokales Video Element vorbereiten
            myVideoElement = createVideoElement(stream);
            myVideoElement.muted = true; // Eigenes Video stummschalten
            
            // Falls Spieler, lokales Video speichern für updateUI
            if (!isHost && myPlayerIndex !== null) {
                videoElements[myPlayerIndex] = myVideoElement;
            } else if (isHost) {
                 const hostSlot = document.querySelector('.gm-cam-slot');
                 if (hostSlot) hostSlot.insertBefore(myVideoElement, hostSlot.firstChild);
            }

            // 2. PeerJS Setup (Für Verbindung zu anderen)
            myPeer = new Peer(null, { debug: 1 });
            
            myPeer.on('open', (id) => {
                if(!isHost && myPlayerIndex !== null) {
                    // ID in Firebase speichern, damit andere uns anrufen können
                    db.child('players').child(myPlayerIndex).update({ peerId: id });
                }
            });

            // Wenn wir angerufen werden (von Host oder anderen Spielern)
            myPeer.on('call', (call) => {
                call.answer(localStream); // Mit eigenem Bild antworten
                call.on('stream', (remoteStream) => {
                    // Wir müssen wissen, von wem der Stream kommt. 
                    // Mapping geschieht über PeerID lookup in localState (siehe updateUI)
                    handleIncomingStream(call.peer, remoteStream);
                });
            });

            updateUI(); // Initiale UI
        } catch (err) {
            console.error("Kamera Zugriff verweigert oder Fehler:", err);
        }
    }
    
    // Hilfsfunktion: Erstellt standardisiertes Video-Objekt
    function createVideoElement(srcObject) {
        const vid = document.createElement('video');
        vid.srcObject = srcObject;
        vid.autoplay = true;
        vid.playsInline = true;
        vid.style.width = '100%';
        vid.style.height = '100%';
        vid.style.objectFit = 'cover';
        vid.style.position = 'absolute';
        vid.style.top = '0';
        vid.style.left = '0';
        vid.style.zIndex = '0'; 
        return vid;
    }

    // Hilfsfunktion: Stream einem Spieler zuordnen
    function handleIncomingStream(peerId, stream) {
        if (!localState.players) return;
        const index = localState.players.findIndex(p => p.peerId === peerId);
        if (index !== -1 && !videoElements[index]) {
            videoElements[index] = createVideoElement(stream);
            updateUI(); // Video in Slot einfügen
        }
    }

    if (!isHost) {
        document.body.classList.add('is-player');
        const userName = prompt("Dein Name:");
        if (userName) {
            db.child('players').child(myPlayerIndex).update({ name: userName });
            initCamera(); 
        }
    } else {
        initCamera(); 
    }

    let audioUnlocked = false;
    function unlockAudio() {
        if(audioUnlocked) return;
        ['correct', 'wrong', 'buzzer'].forEach(id => {
            const a = document.getElementById('sound-' + id);
            a.volume = 0; 
            a.play().then(() => { 
                a.pause(); 
                a.currentTime = 0; 
                a.volume = 1; 
            }).catch(()=>{});
        });
        audioUnlocked = true;
    }

    const boards = {
        1: { 
            "KATEGORIE 1": [{pts:100,q:"Frage",a:"A"},{pts:200,q:"Frage",a:"A"},{pts:300,q:"Frage",a:"A"},{pts:500,q:"Frage",a:"A"}],
            "KATEGORIE 2": [{pts:100,q:"Frage",a:"A"},{pts:200,q:"Frage",a:"A"},{pts:300,q:"Frage",a:"A"},{pts:500,q:"Frage",a:"A"}],
            "KATEGORIE 3": [{pts:100,q:"Frage",a:"A"},{pts:200,q:"Frage",a:"A"},{pts:300,q:"Frage",a:"A"},{pts:500,q:"Frage",a:"A"}],
            "KATEGORIE 4": [{pts:100,q:"Frage",a:"A"},{pts:200,q:"Frage",a:"A"},{pts:300,q:"Frage",a:"A"},{pts:500,q:"Frage",a:"A"}],
            "KATEGORIE 5": [{pts:100,q:"Frage",a:"A"},{pts:200,q:"Frage",a:"A"},{pts:300,q:"Frage",a:"A"},{pts:500,q:"Frage",a:"A"}],
            "KATEGORIE 6": [{pts:100,q:"Frage",a:"A"},{pts:200,q:"Frage",a:"A"},{pts:300,q:"Frage",a:"A"},{pts:500,q:"Frage",a:"A"}] 
        },
        2: { 
            "THEMA 1": [{pts:200,q:"Frage",a:"A"},{pts:400,q:"Frage",a:"A"},{pts:600,q:"Frage",a:"A"},{pts:1000,q:"Frage",a:"A"}],
            "THEMA 2": [{pts:200,q:"Frage",a:"A"},{pts:400,q:"Frage",a:"A"},{pts:600,q:"Frage",a:"A"},{pts:1000,q:"Frage",a:"A"}],
            "THEMA 3": [{pts:200,q:"Frage",a:"A"},{pts:400,q:"Frage",a:"A"},{pts:600,q:"Frage",a:"A"},{pts:1000,q:"Frage",a:"A"}],
            "THEMA 4": [{pts:200,q:"Frage",a:"A"},{pts:400,q:"Frage",a:"A"},{pts:600,q:"Frage",a:"A"},{pts:1000,q:"Frage",a:"A"}],
            "THEMA 5": [{pts:200,q:"Frage",a:"A"},{pts:400,q:"Frage",a:"A"},{pts:600,q:"Frage",a:"A"},{pts:1000,q:"Frage",a:"A"}],
            "THEMA 6": [{pts:200,q:"Frage",a:"A"},{pts:400,q:"Frage",a:"A"},{pts:600,q:"Frage",a:"A"},{pts:1000,q:"Frage",a:"A"}]
        }
    };

    let localState = {};

    db.on('value', (snapshot) => {
        const newState = snapshot.val();
        if(!newState || !newState.players) return;
        
        if(newState.lastEffect && newState.lastEffect !== localState.lastEffect) {
            if(newState.lastEffect === 'correct') triggerFlash('green');
            if(newState.lastEffect === 'wrong') triggerFlash('red');
            const s = document.getElementById('sound-' + newState.lastEffect);
            if(s) { 
                s.currentTime = 0; 
                s.volume = 1;
                s.play().catch(e => console.log("Audio play error", e)); 
            }
        }

        localState = newState;
        updateUI();
    });

    function updateUI() {
        if (!localState.players) return;

        if (!isHost && localState.players[myPlayerIndex]) {
            document.querySelector('.logo-text').innerText = "DU BIST: " + (localState.players[myPlayerIndex].name || "Spieler");
        }

        const board = document.getElementById('game-board');
        board.innerHTML = '';
        const currentB = localState.currentBoard || 1;
        const data = boards[currentB];
        const cats = Object.keys(data);

        cats.forEach(c => {
            const h = document.createElement('div'); h.className = 'category-header'; h.innerText = c; board.appendChild(h);
        });

        for(let i=0; i<4; i++) {
            cats.forEach(c => {
                const q = data[c][i];
                const cardId = `${currentB}-${c}-${i}`;
                const card = document.createElement('div'); card.className = 'quiz-card';
                if(localState.usedCards?.[currentB]?.includes(cardId)) card.classList.add('used');
                card.innerText = q ? q.pts : "";
                card.onclick = () => { if(isHost && q && !card.classList.contains('used')) openQuestion(q, cardId); };
                board.appendChild(card);
            });
        }

        const area = document.getElementById('player-area');
        // WICHTIG: Vor dem Leeren des InnerHTML müssen wir Video-Elemente retten (detach), sonst bricht der Stream ab
        Object.values(videoElements).forEach(vid => vid.remove());
        area.innerHTML = '';
        
        localState.players.forEach((p, i) => {
            const s = document.createElement('div');
            s.className = `player-slot ${localState.activePlayerIndex === i ? 'active-buzzer' : ''} ${localState.selectingPlayerIndex === i ? 'selecting' : ''}`;
            if(i === myPlayerIndex) s.style.border = "4px solid var(--text-gold)";
            
            // LOGIK FÜR NAIVES: "unterhalb der Kamera... immer im Vordergrund"
            const isNaives = p.name === "Naives";
            // Z-Index extrem hoch setzen. Bottom:0 beibehalten (CSS Standard).
            const labelStyle = isNaives ? 'style="z-index: 9999;"' : '';

            s.innerHTML = `<div class="player-info" ${labelStyle}>${p.name}: ${p.score}</div>`;
            s.onclick = () => { if(isHost && !localState.overlayOpen) db.update({selectingPlayerIndex: i}); };
            
            // Video einfügen, wenn vorhanden
            if (videoElements[i]) {
                const vid = videoElements[i];
                // Spezialbehandlung Naives: Video etwas verkürzen, damit Text visuell "darunter" liegt
                if (isNaives) {
                    vid.style.height = '85%'; // Macht Platz unten
                } else {
                    vid.style.height = '100%'; // Standard
                }
                s.insertBefore(vid, s.firstChild);
            }
            
            area.appendChild(s);

            // PeerJS Verbindungslogik: Andere Spieler anrufen, wenn wir deren ID haben
            if (myPeer && p.peerId && p.peerId !== myPeer.id && !peers[p.peerId]) {
                const call = myPeer.call(p.peerId, localStream);
                peers[p.peerId] = call;
                call.on('stream', (remoteStream) => {
                   videoElements[i] = createVideoElement(remoteStream);
                   updateUI();
                });
            }
        });

        const overlay = document.getElementById('question-overlay');
        overlay.style.display = localState.overlayOpen ? 'flex' : 'none';
        
        if (localState.overlayOpen) {
            document.getElementById('question-content').innerText = localState.showAnswerMode ? localState.currentAnswer : localState.currentQuestion;
        }
        
        let statusText = "";
        if(localState.activePlayerIndex !== null) {
            statusText = localState.showAnswerMode ? "RICHTIG!" : localState.players[localState.activePlayerIndex].name.toUpperCase() + " ANTWORTET...";
        } else if(localState.canBuzz) {
            statusText = "BUZZER FREI!";
        } else if (localState.selectingPlayerIndex !== null && !localState.showAnswerMode) {
             statusText = localState.players[localState.selectingPlayerIndex].name + " ist dran...";
        }

        document.getElementById('buzzer-status').innerText = statusText;
        document.getElementById('current-turn-display').innerText = "AM ZUG: " + (localState.selectingPlayerIndex !== null ? localState.players[localState.selectingPlayerIndex].name : "---");
        
        document.getElementById('btn-b1').className = currentB === 1 ? 'btn-nav active' : 'btn-nav';
        document.getElementById('btn-b2').className = currentB === 2 ? 'btn-nav active' : 'btn-nav';
    }

    function openQuestion(q, id) {
        let used = localState.usedCards || {1:[], 2:[]};
        if(!used[localState.currentBoard]) used[localState.currentBoard] = [];
        used[localState.currentBoard].push(id);
        
        let activeP = localState.selectingPlayerIndex !== undefined ? localState.selectingPlayerIndex : null;
        let buzzAllowed = (activeP === null);
        
        db.update({ 
            overlayOpen: true, 
            currentQuestion: q.q, 
            currentAnswer: q.a, 
            currentPoints: q.pts, 
            usedCards: used, 
            activePlayerIndex: activeP,
            canBuzz: buzzAllowed, 
            showAnswerMode: false, 
            lastEffect: '',
            players: localState.players.map(p => ({...p, locked: false})) 
        });
    }

    function handleAnswer(correct) {
        if(localState.activePlayerIndex === null) return;
        let players = [...localState.players];
        if(correct) {
            players[localState.activePlayerIndex].score += localState.currentPoints;
            db.update({ players: players, showAnswerMode: true, canBuzz: false, lastEffect: 'correct' });
        } else {
            players[localState.activePlayerIndex].score -= (localState.currentPoints / 2);
            players[localState.activePlayerIndex].locked = true;
            db.update({ players: players, activePlayerIndex: null, canBuzz: true, lastEffect: 'wrong' });
        }
    }

    function triggerFlash(color) {
        const flash = document.getElementById('flash-overlay');
        flash.style.backgroundColor = color === 'green' ? 'rgba(34, 197, 94, 0.4)' : 'rgba(225, 29, 72, 0.4)';
        flash.style.opacity = '1'; setTimeout(() => flash.style.opacity = '0', 300);
    }

    function closeQuestion() { db.update({overlayOpen: false, activePlayerIndex: null, canBuzz: false, lastEffect: ''}); }
    function switchBoard(n) { db.update({currentBoard: n}); }
    function resetGame() { if(confirm("Reset?")) db.set({ players: [{ name: "S1", score: 0, locked: false }, { name: "S2", score: 0, locked: false }, { name: "S3", score: 0, locked: false }, { name: "S4", score: 0, locked: false }, { name: "S5", score: 0, locked: false }], currentBoard: 1, usedCards: { 1: [], 2: [] }, overlayOpen: false, activePlayerIndex: null, canBuzz: false, selectingPlayerIndex: null, showAnswerMode: false, lastEffect: "" }); }

    window.addEventListener('keydown', (e) => {
        if (!isHost && myPlayerIndex !== null && localState.canBuzz && e.code === "Space") {
            if(!localState.players[myPlayerIndex].locked) {
                db.update({ activePlayerIndex: myPlayerIndex, canBuzz: false, lastEffect: 'buzzer' });
            }
        }
    });
</script>
</body>
</html>
